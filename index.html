<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ƒê·ªë vui nh·∫≠n th∆∞·ªüng n√† ch·ªã Ng·ªçc</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: Arial, sans-serif; background: linear-gradient(135deg,#e3f2fd 0%,#bbdefb 50%,#90caf9 100%); min-height: 100vh; padding: 20px; overflow-x: hidden; }

  .container { max-width: 800px; margin: 0 auto; position: relative; z-index: 10; }
  .title { text-align: center; color: #1565c0; font-size: 2.5rem; font-weight: bold; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
  .subtitle { text-align: center; color: #1976d2; font-size: 1.3rem; font-style: italic; margin-bottom: 30px; }

  .progress-bar { display: flex; justify-content: center; margin-bottom: 30px; }
  .progress-dot { width: 15px; height: 15px; border-radius: 50%; margin: 0 5px; transition: all 0.3s ease; border: 2px solid #2196f3; }
  .progress-dot.completed { background-color: #4caf50; border-color: #4caf50; }
  .progress-dot.current { background-color: #2196f3; transform: scale(1.2); box-shadow: 0 0 15px rgba(33,150,243,0.5); }
  .progress-dot.pending { background-color: #e0e0e0; border-color: #e0e0e0; }

  .puzzle-card { background: linear-gradient(135deg,#ffffff 0%,#f8fbff 100%); border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 3px solid #81d4fa; margin-bottom: 20px; transition: all 0.3s ease; }
  .puzzle-number { text-align: center; color: #0277bd; font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; }
  .question-card { background: rgba(255,255,255,0.9); border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 2px solid #e1f5fe; }
  .question-text { font-size: 1.1rem; line-height: 1.6; color: #424242; }

  .hint-section { text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(33,150,243,0.1); border-radius: 10px; display:none; }
  .hint-label { color: #1976d2; font-weight: bold; margin-bottom: 10px; }
  .hint-display { display: flex; flex-wrap: wrap; justify-content: center; gap: .25em; align-items: center; max-width: 100%; margin: 0 auto; word-break: break-word; overflow-wrap: anywhere; font-family: 'Courier New', monospace; font-size: 1.8rem; letter-spacing: 0.15em; color: #1565c0; font-weight: bold; }
  .hint-char { margin: 0 0.02em; min-width: 0.6em; text-align: center; }
  .revealed { color: #1976d2; }
  .hidden { color: #90a4ae; }
  .hint-char.space { min-width: 0.6em; color: transparent; border: none; }

  .input-section { margin-bottom: 20px; }
  .answer-input { width: 100%; padding: 15px; font-size: 1.1rem; border: 2px solid #81d4fa; border-radius: 10px; background: rgba(255,255,255,0.9); transition: all .3s ease; }
  .answer-input:focus { outline: none; border-color:#2196f3; background:white; box-shadow: 0 0 10px rgba(33,150,243,.3); }

  .button-section { display: flex; gap: 15px; justify-content: center; }
  .btn { padding: 12px 25px; font-size: 1rem; border: none; border-radius: 25px; cursor: pointer; transition: all .3s ease; font-weight: bold; }
  .btn-primary { background: linear-gradient(45deg,#42a5f5,#1e88e5); color: white; }
  .btn-primary:hover { background: linear-gradient(45deg,#1e88e5,#1565c0); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(33,150,243,.4); }
  .btn-secondary { background: white; color:#1565c0; border:2px solid #42a5f5; }
  .btn-secondary:hover { background: rgba(66,165,245,.1); transform: translateY(-2px); }
  .btn:disabled { opacity:.5; cursor:not-allowed; transform:none; }

  .completed-section { margin-top: 20px; text-align: center; }
  .completed-chips { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:10px; }
  .chip { background: linear-gradient(45deg,#4caf50,#388e3c); color: white; padding: 5px 15px; border-radius: 20px; font-size: .9rem; font-weight: bold; }

  .fireworks { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; }
  .firework { position: absolute; font-size: 40px; animation: firework 2s ease-out forwards; }
  @keyframes firework { 0% { transform: scale(0) rotate(0deg); opacity: 1; } 50% { transform: scale(1) rotate(180deg); opacity: 1; } 100% { transform: scale(1.5) rotate(360deg); opacity: 0; } }

  .floating-hearts { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }
  .floating-heart { position: absolute; font-size: 30px; color: #FFB6C1; filter: drop-shadow(0 0 8px rgba(255,182,193,.6)); animation: float 4s ease-in-out infinite; }
  @keyframes float { 0%,100% { transform: translateY(100vh) scale(0); opacity: 0; } 10% { transform: translateY(90vh) scale(1); opacity:.7; } 90% { transform: translateY(-10vh) scale(1); opacity:.7; } 100% { transform: translateY(-20vh) scale(0); opacity: 0; } }

  .final-page { text-align: center; animation: fadeIn 2s ease-in-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  .final-title { font-size: 3rem; color: #1565c0; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }

  .final-message { background: linear-gradient(135deg,#fff3e0 0%,#ffe0b2 100%); border: 3px solid #ffb74d; border-radius: 20px; padding: 30px; margin: 30px 0; position: relative; z-index: 2; }
  .final-message h3 { color:#e65100; margin-bottom: 15px; }
  .final-message p { color:#bf360c; font-size: 1.3rem; line-height: 1.6; font-style: italic; }

  .icons-section { display:flex; justify-content:center; gap:20px; margin:30px 0; font-size: 40px; }
  .keywords-section { margin: 30px 0; }
  .keywords-chips { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin-top:15px; }
  .keyword-chip { background: linear-gradient(45deg,#42a5f5,#1e88e5); color:white; padding:10px 20px; border-radius:25px; font-size:1.1rem; font-weight:bold; animation: popIn .5s ease-out forwards; transform: scale(0); }
  @keyframes popIn { to { transform: scale(1); } }

  .secret-message { color:#424242; font-style: italic; opacity:.8; margin-top: 20px; }

  .shake { animation: shake .4s linear 0s 1; }
  @keyframes shake { 0%{transform:translateX(0);} 20%{transform:translateX(-6px);} 40%{transform:translateX(6px);} 60%{transform:translateX(-4px);} 80%{transform:translateX(4px);} 100%{transform:translateX(0);} }
  .wrong-flash { box-shadow: 0 0 0 3px #ff5252 inset !important; }

  @media (max-width: 480px){
    .title { font-size: 1.8rem; }
    .final-title { font-size: 2rem; }
    .subtitle { font-size: 1rem; }
    .keyword-chip { font-size: .9rem; padding: 6px 12px; }
    .hint-display { font-size: 1.2rem; letter-spacing: .08em; gap: .18em; }
  }

  .toast { position: fixed; top: 20px; right: 20px; background: #ffebee; color:#c62828; border: 2px solid #ef5350; padding: 10px 14px; border-radius: 12px; font-weight: 700; box-shadow: 0 6px 20px rgba(0,0,0,.12); z-index: 2000; }

  /* ===== Big heart canvas at the bottom (wraps "L·ªùi ch√∫c") ===== */
  #heartBigCanvasWrap { position: fixed; left: 0; right: 0; bottom: 0; width: 100%; height: 60vh; pointer-events: none; z-index: 950; display: none; }
  #heartBigCanvas { width: 100%; height: 100%; display: block; }
</style>
</head>
<body>
  <div class="floating-hearts" id="floatingHearts"></div>
  <div class="fireworks" id="fireworks"></div>
  <div id="heartBigCanvasWrap"><canvas id="heartBigCanvas"></canvas></div>

  <div class="container">
    <div id="gameContent">
      <h1 class="title">üß© C√¢u ƒë·ªë b√≠ ·∫©n üß©</h1>
      <p class="subtitle">Gi·∫£i m√£ ƒë·ªÉ kh√°m ph√° th√¥ng ƒëi·ªáp ƒë·∫∑c bi·ªát! ‚ú®</p>
      <div class="progress-bar" id="progressBar"></div>

      <div class="puzzle-card" id="puzzleCard">
        <div class="puzzle-number" id="puzzleNumber"></div>
        <div class="question-card"><div class="question-text" id="questionText"></div></div>

        <div class="hint-section" id="hintSection">
          <div class="hint-label">G·ª£i √Ω:</div>
          <div class="hint-display" id="hintDisplay"></div>
        </div>

        <div class="input-section"><input type="text" class="answer-input" id="answerInput" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n..." /></div>
        <div class="button-section">
          <button class="btn btn-primary" id="checkBtn">Ki·ªÉm tra ƒë√°p √°n</button>
          <button class="btn btn-secondary" id="hintBtn">G·ª£i √Ω (<span id="hintCount">0</span>/5)</button>
        </div>

        <div class="completed-section" id="completedSection" style="display:none;">
          <p style="color:#1976d2; font-weight:bold; margin-bottom:10px;">ƒê√£ ho√†n th√†nh:</p>
          <div class="completed-chips" id="completedChips"></div>
        </div>
      </div>
    </div>

    <div id="finalPage" style="display:none;">
      <div class="final-page">
        <h1 class="final-title"> CH√öC M·ª™NG! </h1>
        <p style="font-size:1.2rem; color:#1565c0; font-style: italic; margin-bottom:30px;">Ch·ªã ƒë√£ gi·∫£i ƒë∆∞·ª£c t·∫•t c·∫£ c√¢u ƒë·ªë!</p>
        <h2 class="final-title">üéâ üéâ üéâ</h2>

        <div class="keywords-section">
          <h3 style="color:#1976d2; margin-bottom: 15px;">C√°c t·ª´ kh√≥a ƒë√£ t√¨m ƒë∆∞·ª£c:</h3>
          <div class="keywords-chips" id="finalKeywords"></div>
        </div>

        <div class="final-message" id="finalMessage">
          <h3>üíù Ch√∫c m·ª´ng ch·ªã Ng·ªçc üíù</h3>
          <p>"V·∫≠y l√† ch·∫∑ng ƒë∆∞·ªùng kh·∫≥ng ƒë·ªãnh nƒÉng l·ª±c c·ªßa b·∫£n th√¢n m√¨nh ƒë√£ k·∫øt th√∫c m·ªôt c√°ch xu·∫•t s·∫Øc. Ch√∫c m·ª´ng ch·ªã ƒë√£ ch√≠nh th·ª©c b∆∞·ªõc sang m·ªôt trang m·ªõi! Em tin r·∫±ng, v·ªõi nh·ªØng n·ªó l·ª±c ƒë√£ b·ªè ra, ch·ªã s·∫Ω th√†nh c√¥ng n·ªëi ti·∫øp th√†nh c√¥ng, v√† m·ªçi n·ªó l·ª±c s·∫Ω v·∫Ω n√™n m·ªôt t∆∞∆°ng lai th·∫≠t r·ª±c r·ª° cho ri√™ng m√¨nh."</p>
        </div>

        <div class="icons-section">
          <span style="color:#e91e63;">üå∏</span>
          <span style="color:#ff9800;">‚ú®</span>
          <span style="color:#f06292;">üíñ</span>
          <span style="color:#ff9800;">‚ú®</span>
          <span style="color:#e91e63;">üå∏</span>
        </div>

        <p class="secret-message">V·ªõi t·∫•t c·∫£ t√¨nh c·∫£m v√† l·ªùi ch√∫c t·ªët ƒë·∫πp nh·∫•t... üíô</p>
      </div>
    </div>
  </div>

  <audio id="bg-music" loop>
    <source src="music.mp3" type="audio/mpeg" />
  </audio>

  <script>
    const bgMusic = document.getElementById('bg-music');
    function fadeInMusic(){ if(!bgMusic) return; bgMusic.volume=0; const target=0.5, dur=3000; const step=target/(dur/100); function up(){ if(bgMusic.volume<target){ bgMusic.volume=Math.min(bgMusic.volume+step,target); setTimeout(up,100);} } bgMusic.play().then(()=>up()).catch(()=>{ const onFirst=()=>{ bgMusic.play().then(()=>up()); window.removeEventListener('click',onFirst); window.removeEventListener('keydown',onFirst); }; window.addEventListener('click',onFirst); window.addEventListener('keydown',onFirst); }); }
    function fadeOutMusic(){ if(!bgMusic) return; const step=bgMusic.volume/20; (function down(){ if(bgMusic.volume>0){ bgMusic.volume=Math.max(bgMusic.volume-step,0); setTimeout(down,100);} else { bgMusic.pause(); bgMusic.currentTime=0; } })(); }
    window.addEventListener('load', fadeInMusic);

    const puzzles=[
      { keyword:'Ch√∫c m·ª´ng', question:'ƒê√¢y l√† t·ª´ d√πng ƒë·ªÉ th·ªÉ hi·ªán ni·ªÅm vui, s·ª± t√°n th∆∞·ªüng khi ai ƒë√≥ ƒë·∫°t ƒë∆∞·ª£c th√†nh t·ª±u, nh∆∞ nh·∫≠n m·ªôt c√¥ng vi·ªác m·ªõi.', answer:'ch√∫c m·ª´ng' },
      { keyword:'Ch√≠nh th·ª©c', question:'T·ª´ n√†y m√¥ t·∫£ m·ªôt tr·∫°ng th√°i ƒë√£ ƒë∆∞·ª£c c√¥ng nh·∫≠n, ƒë∆∞·ª£c ph√™ duy·ªát m·ªôt c√°ch h·ª£p ph√°p, kh√¥ng c√≤n l√† t·∫°m th·ªùi hay th·ª≠ vi·ªác n·ªØa.', answer:'ch√≠nh th·ª©c' },
      { keyword:'Th√†nh c√¥ng', question:'ƒê√¢y l√† k·∫øt qu·∫£ t·ªët ƒë·∫πp c·ªßa m·ªôt qu√° tr√¨nh n·ªó l·ª±c, ƒë·∫°t ƒë∆∞·ª£c m·ª•c ti√™u mong mu·ªën trong c√¥ng vi·ªác ho·∫∑c cu·ªôc s·ªëng.', answer:'th√†nh c√¥ng' },
      { keyword:'R·ª±c r·ª°', question:'T·ª´ n√†y mi√™u t·∫£ √°nh s√°ng l·∫•p l√°nh v√† ch√≥i l√≤a, nh∆∞ng c≈©ng th∆∞·ªùng ƒë∆∞·ª£c d√πng ƒë·ªÉ v√≠ von cho m·ªôt t∆∞∆°ng lai ƒë·∫ßy h·ª©a h·∫πn, t∆∞∆°i s√°ng.', answer:'r·ª±c r·ª°' },
      { keyword:'T∆∞∆°ng lai', question:'C·ª•m t·ª´ ch·ªâ kho·∫£ng th·ªùi gian ph√≠a tr∆∞·ªõc, n∆°i ch√∫ng ta h∆∞·ªõng ƒë·∫øn v·ªõi hy v·ªçng v√† k·∫ø ho·∫°ch.', answer:'t∆∞∆°ng lai' }
    ];

    let currentPuzzle=0, hints=[], completedAnswers=[], gameCompleted=false, sfxEnabled=true, bgmPlaying=false;

    // ===== AudioKit =====
    const AudioKit=(function(){
      let ctx; const ensure=()=>{ if(!ctx) ctx=new (window.AudioContext||window.webkitAudioContext)(); return ctx; };
      const now=()=>ensure().currentTime;
      function tone(f,d=.2,t='sine',g=.06){ const c=ensure(), o=c.createOscillator(), ga=c.createGain(); o.type=t; o.frequency.value=f; ga.gain.setValueAtTime(0,now()); ga.gain.linearRampToValueAtTime(g,now()+.01); ga.gain.exponentialRampToValueAtTime(.0001,now()+d); o.connect(ga).connect(c.destination); o.start(); o.stop(now()+d+.02); }
      function chord(freqs=[261.63,329.63,392.00],d=1.2,t='sine',g=.045){ const c=ensure(), ga=c.createGain(); ga.gain.value=.0001; ga.connect(c.destination); const st=now(); freqs.forEach(f=>{ const o=c.createOscillator(); o.type=t; o.frequency.value=f; o.connect(ga); o.start(st); o.stop(st+d); }); ga.gain.setValueAtTime(.0001,st); ga.gain.exponentialRampToValueAtTime(g,st+.1); ga.gain.exponentialRampToValueAtTime(.0001,st+d); }
      function arpeggio(seq=[[523.25,.18],[659.25,.18],[783.99,.25],[1046.5,.35]],delay=0){ let t=now()+delay; seq.forEach(p=>{ tone(p[0],p[1],'triangle',.07); t+=p[1]*.9; }); }
      function buzzer(){ const c=ensure(), o=c.createOscillator(), g=c.createGain(); o.type='square'; const t=now(); o.frequency.setValueAtTime(180,t); o.frequency.linearRampToValueAtTime(120,t+.25); g.gain.setValueAtTime(.08,t); g.gain.exponentialRampToValueAtTime(.0001,t+.35); o.connect(g).connect(c.destination); o.start(t); o.stop(t+.4); }
      let bgm={g:null,o:[]};
      function startBgm(){ const c=ensure(); stopBgm(); const g=c.createGain(); g.gain.value=.03; g.connect(c.destination); const base=[261.63,329.63,392.00]; function pad(f){ const o=c.createOscillator(); o.type='sine'; o.frequency.value=f; o.connect(g); o.start(); return o; } bgm.o=base.map(pad); bgm.g=g; (function breathe(){ if(!bgm.g) return; const ct=now(); bgm.g.gain.cancelScheduledValues(ct); bgm.g.gain.setValueAtTime(bgm.g.gain.value,ct); bgm.g.gain.linearRampToValueAtTime(.02,ct+2); bgm.g.gain.linearRampToValueAtTime(.04,ct+4); setTimeout(breathe,2000); })(); bgmPlaying=true; }
      function stopBgm(){ if(bgm.o){ bgm.o.forEach(o=>{ try{o.stop();}catch(e){} }); } bgm={g:null,o:[]}; bgmPlaying=false; }
      function finalFanfare(){ chord([392.00,493.88,659.25],.8,'triangle',.06); setTimeout(()=>{ arpeggio([[523.25,.18],[659.25,.18],[783.99,.22],[1046.5,.35]]); },120); setTimeout(()=>{ chord([523.25,659.25,783.99],1.2,'sine',.06); },450); }
      return { tone, chord, arpeggio, buzzer, startBgm, stopBgm, finalFanfare };
    })();

    const quips=["√îi kh√¥ng! GPS l·∫°c h∆∞·ªõng r·ªìi ü§≠","G·∫ßn ƒë√∫ng r·ªìi ƒë√≥, th√™m x√≠u mu·ªëi n·ªØa nha! üßÇ","Sai nh·∫π th√¥i, th·ª≠ l·∫ßn n·ªØa cho ng·∫ßu n√†o üí™","M√°y ch·ªß b·∫£o: 'Sai r√πi n√®!' üòú","ƒê√°p √°n n√© ch·ªã m·ªôt ch√∫t x√≠u th√¥i! ‚ú®"];

    function updateProgressBar(){ const bar=document.getElementById('progressBar'); bar.innerHTML=''; for(let i=0;i<puzzles.length;i++){ const dot=document.createElement('div'); dot.className='progress-dot '+(i<currentPuzzle?'completed':(i===currentPuzzle?'current':'pending')); bar.appendChild(dot);} }

    function loadPuzzle(){ if(currentPuzzle>=puzzles.length){ showFinalPage(); return; } const p=puzzles[currentPuzzle]; document.getElementById('puzzleNumber').textContent='C√¢u '+(currentPuzzle+1)+' / '+puzzles.length; document.getElementById('questionText').textContent=p.question; document.getElementById('answerInput').value=''; hints=[]; updateHintDisplay(); updateCompletedSection(); }

    function generateHint(){ const answer=puzzles[currentPuzzle].answer; const avail=[]; for(let i=0;i<answer.length;i++){ if(answer[i]===' ') continue; const has=hints.some(h=>h.position===i); if(!has) avail.push(i); } if(avail.length>0 && hints.length<5){ const pos=avail[Math.floor(Math.random()*avail.length)]; hints.push({position:pos, character:answer[pos]}); updateHintDisplay(); } }

    function updateHintDisplay(){ const section=document.getElementById('hintSection'); const display=document.getElementById('hintDisplay'); const count=document.getElementById('hintCount'); count.textContent=hints.length; if(hints.length>0){ section.style.display='block'; const answer=puzzles[currentPuzzle].answer; const frag=document.createDocumentFragment(); for(let i=0;i<answer.length;i++){ const span=document.createElement('span'); const hint=hints.find(h=>h.position===i); if(answer[i]===' '){ span.className='hint-char space'; span.innerHTML='&nbsp;'; } else if(hint){ span.className='hint-char revealed'; span.textContent=hint.character; } else { span.className='hint-char hidden'; span.textContent='_'; } frag.appendChild(span);} display.innerHTML=''; display.appendChild(frag); } else { section.style.display='none'; } }

    function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),1600); }

    function wrongEffects(){ const input=document.getElementById('answerInput'); const card=document.getElementById('puzzleCard'); input.classList.add('wrong-flash'); card.classList.add('shake'); setTimeout(()=>{ input.classList.remove('wrong-flash'); card.classList.remove('shake'); },500); toast(quips[Math.floor(Math.random()*quips.length)]); if(sfxEnabled) AudioKit.buzzer(); }

    function correctEffects(){ if(sfxEnabled){ AudioKit.arpeggio(); AudioKit.chord([261.63,329.63,392.00],.7,'sine',.05);} showFireworks(); }

    function checkAnswer(){ const user=document.getElementById('answerInput').value.toLowerCase().trim(); const correct=puzzles[currentPuzzle].answer; try{ AudioKit.tone(10,.01,'sine',.00001);}catch(e){} if(user===correct){ completedAnswers.push(puzzles[currentPuzzle].keyword); correctEffects(); const wasFourth=currentPuzzle===3; const wasFifth=currentPuzzle===4; setTimeout(()=>{ currentPuzzle++; if(currentPuzzle<puzzles.length){ updateProgressBar(); loadPuzzle(); if(sfxEnabled && wasFourth){ AudioKit.chord([329.63,392.00,523.25],.6,'triangle',.05);} } else { if(sfxEnabled && wasFifth){ AudioKit.finalFanfare(); } showFinalPage(); } },1200); } else { wrongEffects(); } }

    function showFireworks(){ const container=document.getElementById('fireworks'); const colors=['#FFD700','#FF69B4','#00CED1','#FF6347','#9370DB']; for(let i=0;i<8;i++){ setTimeout(()=>{ const fw=document.createElement('div'); fw.className='firework'; fw.textContent='üéÜ'; fw.style.left=Math.random()*100+'%'; fw.style.top=Math.random()*100+'%'; fw.style.color=colors[i%colors.length]; container.appendChild(fw); setTimeout(()=>{ if(container.contains(fw)) container.removeChild(fw); },2000); }, i*200); } }

    function createFloatingHearts(){ const container=document.getElementById('floatingHearts'); setInterval(()=>{ if(gameCompleted){ const h=document.createElement('div'); h.className='floating-heart'; h.textContent='üíñ'; h.style.left=Math.random()*100+'%'; h.style.animationDelay=Math.random()*2+'s'; container.appendChild(h); setTimeout(()=>{ if(container.contains(h)) container.removeChild(h); },4000); } },1000); }

    function updateCompletedSection(){ const section=document.getElementById('completedSection'); const chips=document.getElementById('completedChips'); if(completedAnswers.length>0){ section.style.display='block'; chips.innerHTML=''; completedAnswers.forEach(ans=>{ const chip=document.createElement('div'); chip.className='chip'; chip.textContent=ans; chips.appendChild(chip); }); } else { section.style.display='none'; } }

    // ===== BIG HEART (bottom, wraps "L·ªùi ch√∫c") =====
    function startBigHeart(){
      const wrap=document.getElementById('heartBigCanvasWrap');
      const canvas=document.getElementById('heartBigCanvas');
      const ctx=canvas.getContext('2d');
      wrap.style.display='block';

      // Match canvas size to its CSS box
      function resize(){ canvas.width=wrap.clientWidth; canvas.height=wrap.clientHeight; }
      resize();
      window.addEventListener('resize', resize);

      // Locate the "L·ªùi ch√∫c" box and compute a heart scale so it ENVELOPS it
      const msg=document.getElementById('finalMessage');
      const msgRect=msg.getBoundingClientRect();
      const wrapRect=wrap.getBoundingClientRect();

      // Heart parametric base bounds ~ width=32, height=30
      const HEART_W=32, HEART_H=30;

      // Center of message relative to canvas
      const msgCx=(msgRect.left+msgRect.width/2)-wrapRect.left;
      const msgCy=(msgRect.top+msgRect.height/2)-wrapRect.top;

      // Scale so inner area fits message with margin
      const marginX=msgRect.width*0.15; // 15% horizontal margin
      const marginY=msgRect.height*0.35; // more vertical room
      const scaleX=(msgRect.width+marginX)/HEART_W;
      const scaleY=(msgRect.height+marginY)/HEART_H;
      const scale=Math.max(scaleX, scaleY);

      // Generate particle field once (dense border, sparser inside)
      const particles=[];
      const N=2400; // total dots
      for(let i=0;i<N;i++){
        const t=Math.random()*Math.PI*2; // angle along curve
        // radius factor (0.55..1) biased toward border (1.0)
        const rFactor=0.55 + 0.45*Math.pow(Math.random(), 3);
        const xBase=16*Math.pow(Math.sin(t),3);
        const yBase=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t);
        const x=xBase*rFactor;
        const y=yBase*rFactor;
        // small jitter to avoid perfect bands
        const jx=(Math.random()-0.5)*0.25;
        const jy=(Math.random()-0.5)*0.25;
        particles.push({ x:(x+jx)*scale + msgCx, y:-(y+jy)*scale + msgCy, r: 0.8 + Math.random()*1.6, phase: Math.random()*Math.PI*2, speed: 0.9+Math.random()*0.6 });
      }

      let time=0;
      function draw(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        time+=0.016;
        // gentle heartbeat (0.0X scale)
        const pulse=1 + 0.035*Math.sin(time*2.2);

        // gradient centered on heart center
        const grad=ctx.createRadialGradient(msgCx, msgCy, Math.max(scale*4, 20), msgCx, msgCy, scale*22);
        grad.addColorStop(0,'rgba(255,255,255,0.95)');
        grad.addColorStop(0.45,'rgba(255,105,180,0.85)');
        grad.addColorStop(1,'rgba(255,0,0,0.75)');
        ctx.fillStyle=grad;

        for(const p of particles){
          // subtle breathing wobble per-dot
          const wobble=Math.sin(time*p.speed + p.phase)*0.6;
          ctx.beginPath();
          ctx.arc(
            msgCx + (p.x - msgCx)*pulse + wobble,
            msgCy + (p.y - msgCy)*pulse + wobble,
            p.r,
            0, Math.PI*2
          );
          ctx.fill();
        }
        requestAnimationFrame(draw);
      }
      draw();
    }

    function showFinalPage(){
      gameCompleted=true;
      document.getElementById('gameContent').style.display='none';
      document.getElementById('finalPage').style.display='block';
      const finalKeywords=document.getElementById('finalKeywords');
      completedAnswers.forEach((ans,i)=>{ setTimeout(()=>{ const chip=document.createElement('div'); chip.className='keyword-chip'; chip.textContent=ans; chip.style.animationDelay=i*0.2+'s'; finalKeywords.appendChild(chip); }, i*300); });
      showFireworks(); setInterval(showFireworks,5000);
      if(sfxEnabled) { AudioKit.finalFanfare(); }

      // Start big heart after layout is stable
      setTimeout(startBigHeart, 50);
      // Add bottom padding so content doesn't clash with fixed canvas
      document.body.style.paddingBottom = '55vh';
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    document.getElementById('checkBtn').addEventListener('click', checkAnswer);
    document.getElementById('hintBtn').addEventListener('click', generateHint);
    document.getElementById('answerInput').addEventListener('keypress', e=>{ if(e.key==='Enter') checkAnswer(); });
    document.getElementById('answerInput').addEventListener('input', e=>{ document.getElementById('checkBtn').disabled=!e.target.value.trim(); });

    bgmPlaying=true; sfxEnabled=true; AudioKit.startBgm();

    function initGame(){ updateProgressBar(); loadPuzzle(); createFloatingHearts(); }
    initGame();
  </script>
</body>
</html>
