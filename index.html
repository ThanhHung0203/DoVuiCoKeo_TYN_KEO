<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ƒê·ªë vui nh·∫≠n th∆∞·ªüng n√† ch·ªã Ng·ªçc</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 50%, #90caf9 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }

        .title {
            text-align: center;
            color: #1565c0;
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            text-align: center;
            color: #1976d2;
            font-size: 1.3rem;
            font-style: italic;
            margin-bottom: 30px;
        }

        .audio-controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .toggle {
            border: 2px solid #42a5f5;
            background: white;
            color: #1565c0;
            padding: 8px 14px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 700;
            transition: .2s;
        }

        .toggle:hover {
            background: rgba(66, 165, 245, .1);
            transform: translateY(-1px);
        }

        .progress-bar {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .progress-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin: 0 5px;
            transition: all 0.3s ease;
            border: 2px solid #2196f3;
        }

        .progress-dot.completed {
            background-color: #4caf50;
            border-color: #4caf50;
        }

        .progress-dot.current {
            background-color: #2196f3;
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.5);
        }

        .progress-dot.pending {
            background-color: #e0e0e0;
            border-color: #e0e0e0;
        }

        .puzzle-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fbff 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 3px solid #81d4fa;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .puzzle-number {
            text-align: center;
            color: #0277bd;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .question-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e1f5fe;
        }

        .question-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #424242;
        }

        .hint-section {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 10px;
        }

        .hint-label {
            color: #1976d2;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .hint-display {
            font-family: 'Courier New', monospace;
            font-size: 1.8rem;
            letter-spacing: 0.3em;
            color: #1565c0;
            font-weight: bold;
        }

        .hint-char {
            margin: 0 2px;
        }

        .revealed {
            color: #1976d2;
        }

        .hidden {
            color: #ccc;
        }

        .input-section {
            margin-bottom: 20px;
        }

        .answer-input {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            border: 2px solid #81d4fa;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }

        .answer-input:focus {
            outline: none;
            border-color: #2196f3;
            background: white;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
        }

        .button-section {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            padding: 12px 25px;
            font-size: 1rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(45deg, #42a5f5, #1e88e5);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #1e88e5, #1565c0);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #1565c0;
            border: 2px solid #42a5f5;
        }

        .btn-secondary:hover {
            background: rgba(66, 165, 245, 0.1);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .completed-section {
            margin-top: 20px;
            text-align: center;
        }

        .completed-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .chip {
            background: linear-gradient(45deg, #4caf50, #388e3c);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .fireworks {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .firework {
            position: absolute;
            font-size: 40px;
            animation: firework 2s ease-out forwards;
        }

        @keyframes firework {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 1;
            }

            50% {
                transform: scale(1) rotate(180deg);
                opacity: 1;
            }

            100% {
                transform: scale(1.5) rotate(360deg);
                opacity: 0;
            }
        }

        .floating-hearts {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        .floating-heart {
            position: absolute;
            font-size: 30px;
            color: #FFB6C1;
            filter: drop-shadow(0 0 8px rgba(255, 182, 193, 0.6));
            animation: float 4s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(100vh) scale(0);
                opacity: 0;
            }

            10% {
                transform: translateY(90vh) scale(1);
                opacity: .7;
            }

            90% {
                transform: translateY(-10vh) scale(1);
                opacity: .7;
            }

            100% {
                transform: translateY(-20vh) scale(0);
                opacity: 0;
            }
        }

        .final-page {
            text-align: center;
            animation: fadeIn 2s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .final-title {
            font-size: 3rem;
            color: #1565c0;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .final-message {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border: 3px solid #ffb74d;
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
        }

        .final-message h3 {
            color: #e65100;
            margin-bottom: 15px;
        }

        .final-message p {
            color: #bf360c;
            font-size: 1.3rem;
            line-height: 1.6;
            font-style: italic;
        }

        .icons-section {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            font-size: 40px;
        }

        .keywords-section {
            margin: 30px 0;
        }

        .keywords-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
        }

        .keyword-chip {
            background: linear-gradient(45deg, #42a5f5, #1e88e5);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            animation: popIn 0.5s ease-out forwards;
            transform: scale(0);
        }

        @keyframes popIn {
            to {
                transform: scale(1);
            }
        }

        .secret-message {
            color: #424242;
            font-style: italic;
            opacity: 0.8;
            margin-top: 20px;
        }

        /* Wrong answer effects */
        .shake {
            animation: shake .4s linear 0s 1;
        }

        @keyframes shake {
            0% {
                transform: translateX(0);
            }

            20% {
                transform: translateX(-6px);
            }

            40% {
                transform: translateX(6px);
            }

            60% {
                transform: translateX(-4px);
            }

            80% {
                transform: translateX(4px);
            }

            100% {
                transform: translateX(0);
            }
        }

        .wrong-flash {
            box-shadow: 0 0 0 3px #ff5252 inset !important;
        }

        @media (max-width: 480px) {
          .title {
            font-size: 1.8rem; /* ~28px, v·ª´a v·ªõi 360px */
          }
          .final-title {
            font-size: 2rem; /* ~32px */
          }
          .subtitle {
            font-size: 1rem; /* ~16px */
          }
          .keyword-chip {
            font-size: 0.9rem;
            padding: 6px 12px;
          }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ffebee;
            color: #c62828;
            border: 2px solid #ef5350;
            padding: 10px 14px;
            border-radius: 12px;
            font-weight: 700;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .12);
            z-index: 2000;
        }
    </style>
</head>

<body>
    <div class="floating-hearts" id="floatingHearts"></div>
    <div class="fireworks" id="fireworks"></div>

    <div class="container">
        <div id="gameContent">
            <h1 class="title">üß© C√¢u ƒë·ªë b√≠ ·∫©n üß©</h1>
            <p class="subtitle">Gi·∫£i m√£ ƒë·ªÉ kh√°m ph√° th√¥ng ƒëi·ªáp ƒë·∫∑c bi·ªát! ‚ú®</p>

            <!-- <div class="audio-controls">
                <button id="bgmToggle" class="toggle">üîà B·∫≠t nh·∫°c n·ªÅn</button>
                <button id="sfxToggle" class="toggle">üîî Hi·ªáu ·ª©ng √¢m thanh: B·∫≠t</button>
            </div> -->

            <div class="progress-bar" id="progressBar"></div>

            <div class="puzzle-card" id="puzzleCard">
                <div class="puzzle-number" id="puzzleNumber"></div>

                <div class="question-card">
                    <div class="question-text" id="questionText"></div>
                </div>

                <div class="hint-section" id="hintSection" style="display: none;">
                    <div class="hint-label">G·ª£i √Ω:</div>
                    <div class="hint-display" id="hintDisplay"></div>
                </div>

                <div class="input-section">
                    <input type="text" class="answer-input" id="answerInput"
                        placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n..." />
                </div>

                <div class="button-section">
                    <button class="btn btn-primary" id="checkBtn">Ki·ªÉm tra ƒë√°p √°n</button>
                    <button class="btn btn-secondary" id="hintBtn">G·ª£i √Ω (<span id="hintCount">0</span>/5)</button>
                </div>

                <div class="completed-section" id="completedSection" style="display: none;">
                    <p style="color: #1976d2; font-weight: bold; margin-bottom: 10px;">ƒê√£ ho√†n th√†nh:</p>
                    <div class="completed-chips" id="completedChips"></div>
                </div>
            </div>
        </div>

        <div id="finalPage" style="display: none;">
            <div class="final-page">
                <h1 class="final-title"> CH√öC M·ª™NG! </h1>
                <p style="font-size: 1.2rem; color: #1565c0; font-style: italic; margin-bottom: 30px;">
                    Ch·ªã ƒë√£ gi·∫£i ƒë∆∞·ª£c t·∫•t c·∫£ c√¢u ƒë·ªë!
                </p>
                <h2 class="final-title">üéâ üéâ üéâ</h2>
                <div class="keywords-section">
                    <h3 style="color: #1976d2; margin-bottom: 15px;">C√°c t·ª´ kh√≥a ƒë√£ t√¨m ƒë∆∞·ª£c:</h3>
                    <div class="keywords-chips" id="finalKeywords"></div>
                </div>

                <div class="final-message">
                    <h3>üíù L·ªùi ch√∫c üíù</h3>
                    <p>
                        "Ch√∫c m·ª´ng ch·ªã Ng·ªçc ƒë√£ tr·ªü th√†nh nh√¢n vi√™n ch√≠nh th·ª©c,
                        ch√∫c ch·ªã g·∫∑t h√°i ƒë∆∞·ª£c nhi·ªÅu th√†nh c√¥ng v√† c√≥ m·ªôt t∆∞∆°ng lai th·∫≠t r·ª±c r·ª° tr√™n con ƒë∆∞·ªùng m√¨nh ch·ªçn!"
                    </p>
                </div>

                <div class="icons-section">
                    <span style="color: #e91e63;">üå∏</span>
                    <span style="color: #ff9800;">‚ú®</span>
                    <span style="color: #f06292;">üíñ</span>
                    <span style="color: #ff9800;">‚ú®</span>
                    <span style="color: #e91e63;">üå∏</span>
                </div>

                <p class="secret-message">V·ªõi t·∫•t c·∫£ t√¨nh c·∫£m v√† l·ªùi ch√∫c t·ªët ƒë·∫πp nh·∫•t... üíô</p>
            </div>
        </div>
    </div>

    <audio id="bg-music" loop>
        <source src="music.mp3" type="audio/mpeg">
    </audio>

    <script>
        const bgMusic = document.getElementById("bg-music");

        function fadeInMusic() {
            if (!bgMusic) return;
            bgMusic.volume = 0;
            const fadeTarget = 0.5;
            const fadeTime = 3000;
            let step = fadeTarget / (fadeTime / 100);

            function fadeIn() {
                if (bgMusic.volume < fadeTarget) {
                    bgMusic.volume = Math.min(bgMusic.volume + step, fadeTarget);
                    setTimeout(fadeIn, 100);
                }
            }

            bgMusic.play().then(() => fadeIn()).catch(() => {
                const onFirstInteraction = () => {
                    bgMusic.play().then(() => fadeIn());
                    window.removeEventListener("click", onFirstInteraction);
                    window.removeEventListener("keydown", onFirstInteraction);
                };
                window.addEventListener("click", onFirstInteraction);
                window.addEventListener("keydown", onFirstInteraction);
            });
        }

        function fadeOutMusic() {
            if (!bgMusic) return;
            let step = bgMusic.volume / 20; // 20 b∆∞·ªõc ƒë·ªÉ t·∫Øt d·∫ßn
            function fade() {
                if (bgMusic.volume > 0) {
                    bgMusic.volume = Math.max(bgMusic.volume - step, 0);
                    setTimeout(fade, 100);
                } else {
                    bgMusic.pause();
                    bgMusic.currentTime = 0;
                }
            }
            fade();
        }

        // g·ªçi khi load game
        window.addEventListener("load", fadeInMusic);
        // ====== DATA (th√™m c√¢u th·ª© 5 theo y√™u c·∫ßu) ======
        var puzzles = [
            { keyword: "Ch√∫c m·ª´ng", question: "ƒê√¢y l√† l·ªùi n√≥i d√πng ƒë·ªÉ th·ªÉ hi·ªán ni·ªÅm vui, s·ª± t√°n th∆∞·ªüng khi ai ƒë√≥ ƒë·∫°t ƒë∆∞·ª£c th√†nh t·ª±u, nh∆∞ nh·∫≠n m·ªôt c√¥ng vi·ªác m·ªõi.", answer: "ch√∫c m·ª´ng" },
            { keyword: "Ch√≠nh th·ª©c", question: "T·ª´ n√†y m√¥ t·∫£ m·ªôt tr·∫°ng th√°i ƒë√£ ƒë∆∞·ª£c c√¥ng nh·∫≠n, ƒë∆∞·ª£c ph√™ duy·ªát m·ªôt c√°ch h·ª£p ph√°p, kh√¥ng c√≤n l√† t·∫°m th·ªùi hay th·ª≠ vi·ªác n·ªØa.", answer: "ch√≠nh th·ª©c" },
            { keyword: "Th√†nh c√¥ng", question: "ƒê√¢y l√† k·∫øt qu·∫£ t·ªët ƒë·∫πp c·ªßa m·ªôt qu√° tr√¨nh n·ªó l·ª±c, ƒë·∫°t ƒë∆∞·ª£c m·ª•c ti√™u mong mu·ªën trong c√¥ng vi·ªác ho·∫∑c cu·ªôc s·ªëng.", answer: "th√†nh c√¥ng" },
            { keyword: "R·ª±c r·ª°", question: "ƒê√¢y l√† m·ªôt t√≠nh t·ª´ mi√™u t·∫£ √°nh s√°ng ch√≥i l√≤a, l·∫•p l√°nh, th∆∞·ªùng d√πng ƒë·ªÉ v√≠ von cho m·ªôt t∆∞∆°ng lai t∆∞∆°i s√°ng, ƒë·∫ßy h·ª©a h·∫πn.", answer: "r·ª±c r·ª°" },
            { keyword: "T∆∞∆°ng lai", question: "C·ª•m t·ª´ ch·ªâ kho·∫£ng th·ªùi gian ph√≠a tr∆∞·ªõc, n∆°i ch√∫ng ta h∆∞·ªõng ƒë·∫øn v·ªõi hy v·ªçng v√† k·∫ø ho·∫°ch.", answer: "t∆∞∆°ng lai" }
        ];

        // ====== STATE ======
        var currentPuzzle = 0;
        var hints = [];
        var completedAnswers = [];
        var gameCompleted = false;
        var sfxEnabled = true;
        var bgmPlaying = false;

        // ====== AUDIO ENGINE (Web Audio API ‚Äì kh√¥ng c·∫ßn file ngo√†i) ======
        var AudioKit = (function () {
            var ctx;
            function ensureCtx() { if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)(); return ctx; }
            function now() { return ensureCtx().currentTime; }
            function tone(freq, duration = 0.2, type = 'sine', gain = 0.06) {
                var c = ensureCtx();
                var o = c.createOscillator();
                var g = c.createGain();
                o.type = type; o.frequency.value = freq;
                g.gain.setValueAtTime(0, now());
                g.gain.linearRampToValueAtTime(gain, now() + 0.01);
                g.gain.exponentialRampToValueAtTime(0.0001, now() + duration);
                o.connect(g).connect(c.destination);
                o.start(); o.stop(now() + duration + 0.02);
            }
            function chord(freqs = [261.63, 329.63, 392.00], duration = 1.2, type = 'sine', gain = 0.045) {
                var c = ensureCtx();
                var g = c.createGain(); g.gain.value = 0.0001;
                g.connect(c.destination);
                var start = now();
                freqs.forEach(function (f) {
                    var o = c.createOscillator(); o.type = type; o.frequency.value = f; o.connect(g); o.start(start); o.stop(start + duration);
                });
                g.gain.setValueAtTime(0.0001, start);
                g.gain.exponentialRampToValueAtTime(gain, start + 0.1);
                g.gain.exponentialRampToValueAtTime(0.0001, start + duration);
            }
            function arpeggio(seq = [[523.25, 0.18], [659.25, 0.18], [783.99, 0.25], [1046.5, 0.35]], delay = 0) {
                var t = now() + delay;
                seq.forEach(function (pair) { tone(pair[0], pair[1], 'triangle', 0.07); t += pair[1] * 0.9; });
            }
            function buzzer() { // sai
                var c = ensureCtx();
                var o = c.createOscillator(); var g = c.createGain();
                o.type = 'square';
                var t = now();
                o.frequency.setValueAtTime(180, t);
                o.frequency.linearRampToValueAtTime(120, t + 0.25);
                g.gain.setValueAtTime(0.08, t);
                g.gain.exponentialRampToValueAtTime(0.0001, t + 0.35);
                o.connect(g).connect(c.destination);
                o.start(t); o.stop(t + 0.4);
            }
            var bgmNodes = { g: null, o: [] };
            function startBgm() {
                var c = ensureCtx();
                stopBgm();
                var g = c.createGain(); g.gain.value = 0.03; g.connect(c.destination);
                var base = [261.63, 329.63, 392.00]; // C major
                function makePad(freq) { var o = c.createOscillator(); o.type = 'sine'; o.frequency.value = freq; o.connect(g); o.start(); return o; }
                bgmNodes.o = base.map(makePad);
                bgmNodes.g = g;
                // gentle breathing
                var t = now();
                function breathe() {
                    if (!bgmNodes.g) return;
                    var ct = now();
                    bgmNodes.g.gain.cancelScheduledValues(ct);
                    bgmNodes.g.gain.setValueAtTime(bgmNodes.g.gain.value, ct);
                    bgmNodes.g.gain.linearRampToValueAtTime(0.02, ct + 2);
                    bgmNodes.g.gain.linearRampToValueAtTime(0.04, ct + 4);
                    setTimeout(breathe, 2000);
                }
                breathe();
                bgmPlaying = true;
            }
            function stopBgm() {
                if (bgmNodes.o) { bgmNodes.o.forEach(function (o) { try { o.stop(); } catch (e) { } }); }
                bgmNodes = { g: null, o: [] };
                bgmPlaying = false;
            }
            function finalFanfare() {
                chord([392.00, 493.88, 659.25], 0.8, 'triangle', 0.06);
                setTimeout(function () { arpeggio([[523.25, 0.18], [659.25, 0.18], [783.99, 0.22], [1046.5, 0.35]]); }, 120);
                setTimeout(function () { chord([523.25, 659.25, 783.99], 1.2, 'sine', 0.06); }, 450);
            }
            return { tone, chord, arpeggio, buzzer, startBgm, stopBgm, finalFanfare };
        })();

        // ====== HUMOROUS WRONG MESSAGES ======
        var quips = [
            "√îi kh√¥ng! GPS l·∫°c h∆∞·ªõng r·ªìi ü§≠",
            "G·∫ßn ƒë√∫ng r·ªìi ƒë√≥, th√™m x√≠u mu·ªëi n·ªØa nha! üßÇ",
            "Sai nh·∫π th√¥i, th·ª≠ l·∫ßn n·ªØa cho ng·∫ßu n√†o üí™",
            "M√°y ch·ªß b·∫£o: 'Sai r√πi n√®!' üòú",
            "ƒê√°p √°n n√© ch·ªã m·ªôt ch√∫t x√≠u th√¥i! ‚ú®"
        ];

        // ====== APP LOGIC ======
        function initGame() { updateProgressBar(); loadPuzzle(); createFloatingHearts(); }

        function updateProgressBar() {
            var progressBar = document.getElementById('progressBar');
            progressBar.innerHTML = '';
            for (var i = 0; i < puzzles.length; i++) {
                var dot = document.createElement('div');
                dot.className = 'progress-dot';
                if (i < currentPuzzle) dot.classList.add('completed');
                else if (i === currentPuzzle) dot.classList.add('current');
                else dot.classList.add('pending');
                progressBar.appendChild(dot);
            }
        }

        function loadPuzzle() {
            if (currentPuzzle >= puzzles.length) { showFinalPage(); return; }
            var puzzle = puzzles[currentPuzzle];
            document.getElementById('puzzleNumber').textContent = 'C√¢u ' + (currentPuzzle + 1) + ' / ' + puzzles.length;
            document.getElementById('questionText').textContent = puzzle.question;
            document.getElementById('answerInput').value = '';
            hints = []; updateHintDisplay(); updateCompletedSection();
        }

        function generateHint() {
            var answer = puzzles[currentPuzzle].answer;
            var availablePositions = [];
            for (var i = 0; i < answer.length; i++) {
                var hasHint = hints.some(function (h) { return h.position === i; });
                if (!hasHint) availablePositions.push(i);
            }
            if (availablePositions.length > 0 && hints.length < 5) {
                var randomPosition = availablePositions[Math.floor(Math.random() * availablePositions.length)];
                hints.push({ position: randomPosition, character: answer[randomPosition] });
                updateHintDisplay();
            }
        }

        function updateHintDisplay() {
            var hintSection = document.getElementById('hintSection');
            var hintDisplay = document.getElementById('hintDisplay');
            var hintCount = document.getElementById('hintCount');
            hintCount.textContent = hints.length;
            if (hints.length > 0) {
                hintSection.style.display = 'block';
                var answer = puzzles[currentPuzzle].answer;
                var display = '';
                for (var i = 0; i < answer.length; i++) {
                    var hint = hints.find(function (h) { return h.position === i; });
                    if (hint) display += '<span class="hint-char revealed">' + hint.character + '</span>';
                    else display += '<span class="hint-char hidden">_</span>';
                }
                hintDisplay.innerHTML = display;
            } else { hintSection.style.display = 'none'; }
        }

        function toast(msg) {
            var t = document.createElement('div'); t.className = 'toast'; t.textContent = msg;
            document.body.appendChild(t); setTimeout(function () { t.remove(); }, 1600);
        }

        function wrongEffects() {
            var input = document.getElementById('answerInput');
            var card = document.getElementById('puzzleCard');
            input.classList.add('wrong-flash'); card.classList.add('shake');
            setTimeout(function () { input.classList.remove('wrong-flash'); card.classList.remove('shake'); }, 500);
            toast(quips[Math.floor(Math.random() * quips.length)]);
            if (sfxEnabled) AudioKit.buzzer();
        }

        function correctEffects() {
            if (sfxEnabled) {
                AudioKit.arpeggio();
                AudioKit.chord([261.63, 329.63, 392.00], 0.7, 'sine', 0.05);
            }
            showFireworks();
        }

        function checkAnswer() {
            var userAnswer = document.getElementById('answerInput').value.toLowerCase().trim();
            var correctAnswer = puzzles[currentPuzzle].answer;
            // start audio context on first interaction
            try { AudioKit.tone(10, 0.01, 'sine', 0.00001); } catch (e) { }

            if (userAnswer === correctAnswer) {
                completedAnswers.push(puzzles[currentPuzzle].keyword);
                correctEffects();
                var wasFourth = currentPuzzle === 3; // v·ª´a tr·∫£ l·ªùi ƒë√∫ng c√¢u th·ª© 4
                var wasFifth = currentPuzzle === 4;  // v·ª´a tr·∫£ l·ªùi ƒë√∫ng c√¢u th·ª© 5
                setTimeout(function () {
                    currentPuzzle++;
                    if (currentPuzzle < puzzles.length) {
                        updateProgressBar();
                        loadPuzzle();
                        // N·∫øu v·ª´a qua c√¢u 4 -> s·∫Øp sang c√¢u 5, c√≥ th·ªÉ nh√° t√≠n hi·ªáu
                        if (sfxEnabled && wasFourth) { AudioKit.chord([329.63, 392.00, 523.25], 0.6, 'triangle', 0.05); }
                    } else {
                        // ƒê√∫ng c√¢u th·ª© 5 v√† sang trang cu·ªëi -> fanfare
                        if (sfxEnabled && wasFifth) { AudioKit.finalFanfare(); }
                        showFinalPage();
                    }
                }, 1200);
            } else {
                wrongEffects();
            }
        }

        function showFireworks() {
            var fireworksContainer = document.getElementById('fireworks');
            var colors = ['#FFD700', '#FF69B4', '#00CED1', '#FF6347', '#9370DB'];
            for (var i = 0; i < 8; i++) {
                (function (index) {
                    setTimeout(function () {
                        var firework = document.createElement('div');
                        firework.className = 'firework'; firework.textContent = 'üéÜ';
                        firework.style.left = Math.random() * 100 + '%';
                        firework.style.top = Math.random() * 100 + '%';
                        firework.style.color = colors[index % colors.length];
                        fireworksContainer.appendChild(firework);
                        setTimeout(function () { if (fireworksContainer.contains(firework)) fireworksContainer.removeChild(firework); }, 2000);
                    }, index * 200);
                })(i);
            }
        }

        function createFloatingHearts() {
            var heartsContainer = document.getElementById('floatingHearts');
            setInterval(function () {
                if (gameCompleted) {
                    var heart = document.createElement('div');
                    heart.className = 'floating-heart'; heart.textContent = 'üíñ';
                    heart.style.left = Math.random() * 100 + '%';
                    heart.style.animationDelay = Math.random() * 2 + 's';
                    heartsContainer.appendChild(heart);
                    setTimeout(function () { if (heartsContainer.contains(heart)) heartsContainer.removeChild(heart); }, 4000);
                }
            }, 1000);
        }

        function updateCompletedSection() {
            var completedSection = document.getElementById('completedSection');
            var completedChips = document.getElementById('completedChips');
            if (completedAnswers.length > 0) {
                completedSection.style.display = 'block';
                completedChips.innerHTML = '';
                completedAnswers.forEach(function (ans) {
                    var chip = document.createElement('div'); chip.className = 'chip'; chip.textContent = ans; completedChips.appendChild(chip);
                });
            } else { completedSection.style.display = 'none'; }
        }

        function showFinalPage() {
            gameCompleted = true;
            document.getElementById('gameContent').style.display = 'none';
            document.getElementById('finalPage').style.display = 'block';
            var finalKeywords = document.getElementById('finalKeywords');
            completedAnswers.forEach(function (answer, index) {
                setTimeout(function () {
                    var chip = document.createElement('div'); chip.className = 'keyword-chip'; chip.textContent = answer; chip.style.animationDelay = index * 0.2 + 's'; finalKeywords.appendChild(chip);
                }, index * 300);
            });
            showFireworks();
            setInterval(showFireworks, 5000);
            // ph√°t nh·∫°c ch√∫c m·ª´ng trang cu·ªëi
            if (sfxEnabled) { AudioKit.finalFanfare(); }
        }

        // ====== UI EVENTS ======
        document.getElementById('checkBtn').addEventListener('click', checkAnswer);
        document.getElementById('hintBtn').addEventListener('click', generateHint);
        document.getElementById('answerInput').addEventListener('keypress', function (e) { if (e.key === 'Enter') checkAnswer(); });
        document.getElementById('answerInput').addEventListener('input', function (e) { document.getElementById('checkBtn').disabled = !e.target.value.trim(); });

        // Audio toggles
        bgmPlaying = true;
        sfxEnabled = true;

        AudioKit.startBgm();

        // ====== INIT ======
        function initGame() { updateProgressBar(); loadPuzzle(); createFloatingHearts(); }
        initGame();
    </script>
</body>


</html>






